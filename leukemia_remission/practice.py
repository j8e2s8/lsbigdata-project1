import pandas as pd
import statsmodels.api as sm



# ë¬¸ì œ1 : ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³ , ë¡œì§€ìŠ¤í‹± íšŒê·€ëª¨ë¸ì„ ì í•©í•˜ê³ , íšŒê·€ í‘œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
df = pd.read_csv('./leukemia_remission/leukemia_remission.txt', delim_whitespace= True) # delim_whitespace : ê³µë°± ì§€ìš°ê¸°
df.head()

train = df.drop(columns=('REMISS'))

model = sm.formula.logit("REMISS ~ CELL + SMEAR + INFIL + LI + BLAST + TEMP", data=df).fit()
print(model.summary())



# ë¬¸ì œ2 : í•´ë‹¹ ëª¨ë¸ì€ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œê°€ìš”? ê·¸ ì´ìœ ë¥¼ ê²€ì •í†µê³„ëŸ‰ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•˜ì‹œì˜¤
# âˆ’2(â„“(ğ›½)Ì‚ (0) âˆ’ â„“(ğ›½)Ì‚ )  =  -2*(-17.186+10.797)  = 12.779
1 - chi2.cdf(12.779, df=6)  # 0.0467

# LLR p-value: 0.0467 < ìœ ì˜ìˆ˜ì¤€ 0.05ë³´ë‹¤ ì‘ìœ¼ë‹ˆê¹Œ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.




# ë¬¸ì œ3 : ìœ ì˜ìˆ˜ì¤€ì´ 0.2ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œ ë³€ìˆ˜ëŠ” ëª‡ê°œì´ë©°, ì–´ëŠ ë³€ìˆ˜ ì¸ê°€ìš”?
# P>|z|ê°€ 0.2ë³´ë‹¤ ì‘ì€ LI, TEMPê°€ ìœ ì˜í•˜ë‹¤



# ë¬¸ì œ4 : ë‹¤ìŒ í™˜ìì— ëŒ€í•œ ì˜¤ì¦ˆëŠ” ì–¼ë§ˆì¸ê°€ìš”?

# CELL (ê³¨ìˆ˜ì˜ ì„¸í¬ì„±): 65%

# SMEAR (ê³¨ìˆ˜í¸ì˜ ë°±í˜ˆêµ¬ ë¹„ìœ¨): 45%

# INFIL (ê³¨ìˆ˜ì˜ ë°±í˜ˆë³‘ ì„¸í¬ ì¹¨íˆ¬ ë¹„ìœ¨): 55%

# LI (ê³¨ìˆ˜ ë°±í˜ˆë³‘ ì„¸í¬ì˜ ë¼ë²¨ë§ ì¸ë±ìŠ¤): 1.2

# BLAST (ë§ì´ˆí˜ˆì•¡ì˜ ë°±í˜ˆë³‘ ì„¸í¬ ìˆ˜): 1.1ì„¸í¬/Î¼L

# TEMP (ì¹˜ë£Œ ì‹œì‘ ì „ ìµœê³  ì²´ì˜¨): 0.9


odds = np.exp( 64.2581 + 30.8301*0.65 + 24.6863 * 0.45  - 24.9745 * 0.55 + 4.3605 * 1.2 - 0.0115*1.1 - 100.1734 * 0.9)  # 0.03817459641135519



# ë¬¸ì œ5 : ìœ„ í™˜ìì˜ í˜ˆì•¡ì—ì„œ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë˜ì§€ ì•Šì€ í™•ë¥ ì€ ì–¼ë§ˆì¸ê°€ìš”?
odds / (1+odds)  # 0.03677088280074742



# ë¬¸ì œ 6 : TEMP ë³€ìˆ˜ì˜ ê³„ìˆ˜ëŠ” ì–¼ë§ˆì´ë©°, í•´ë‹¹ ê³„ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ TEMP ë³€ìˆ˜ê°€ ë°±í˜ˆë³‘ ì¹˜ë£Œì— ëŒ€í•œ ì˜í–¥ì„ ì„¤ëª…í•˜ì‹œì˜¤.
# TEMP ë³€ìˆ˜ì˜ ê³„ìˆ˜ : -100.1734
# TEMP ë³€ìˆ˜ 1 ë‹¨ìœ„ ì¦ê°€í•˜ë©´ ë¡œê·¸ì˜¤ì¦ˆê°€ 100.1734 ê°ì†Œí•˜ëŠ”ë°, ì˜¤ì¦ˆë¹„ëŠ” (e^-100.1734)ë°° ê°ì†Œí•œë‹¤. TEMPê°€ 1ë‹¨ìœ„ ì˜¬ë¼ê°€ë©´, ì˜¤ì¦ˆë¹„ê°€ (e^-100.1734)ë°° ê°ì†Œ. 
# ê´€ì¸¡ ë¶ˆê°€ í™•ë¥ ì´ ê°ì†Œí•œë‹¤. ì¦‰ ê´€ì¸¡ë  í™•ë¥ ì´ ì¦ê°€í•œë‹¤. ë”°ë¼ì„œ ë°±í˜ˆë³‘ ì¹˜ë£Œë¥¼ í•´ì•¼í•œë‹¤.
# np.exp(-100.1734)ì€ 0ì— ê°€ê¹Œìš´ ê°’ì´ë‹¤. ì´ëŠ” ì²´ì˜¨ì´ 1ë‹¨ìœ„ ìƒìŠ¹í•  ë•Œ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë˜ì§€ ì•Šì„ í™•ë¥ ì´ ê±°ì˜ ì—†ì–´ì§€ëŠ” ê²ƒì„ ì˜ë¯¸(ì˜¤ì¦ˆë¹„ë§Œí¼ ë³€ë™)í•œë‹¤. ë”°ë¼ì„œ, ì˜¨ë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë  í™•ë¥  ë†’ì•„ì§„ë‹¤.

np.exp(-100.1734)  # 0

temp = 0 ì¼ ë•Œ, e^0 =1
temp =1 ì¼ ë•Œ e^-100

temp = 0 ì¼ ë•Œ, ë¡œê·¸ì˜¤ì¦ˆ(y) = 200   # yë³€í™”ëŸ‰ = -100.1734  -> ì˜¤ì¦ˆ = e^(200) = 7.225973768125749e+86
temp = 1 ì¼ ë•Œ, ë¡œê·¸ì˜¤ì¦ˆ(y) = 200-100.1734               # ->  ì˜¤ì¦ˆ = e^(99.8266) = e^200 * e^(-100.1734) = 2.2601721913757316e+43  # e^(-100.1734)ë°°'ë¡œ/ë§Œí¼' ê°ì†Œ




temp = 0 ì¼ ë•Œ, ë¡œê·¸ì˜¤ì¦ˆ(y) = 5 # yë³€í™”ëŸ‰ = 7-5 = 2 -> ì˜¤ì¦ˆ = e^(5) = 148.4131591025766
temp = 1 ì¼ ë•Œ, ë¡œê·¸ì˜¤ì¦ˆ(y) = 7                  # ->  ì˜¤ì¦ˆ = e^(5+2) = e^5 * e^2 = 1096.6331584284585  # e^(2) = e^(5+2) / e^(5) = 7.3890560989306495ë°°ë¡œ ì¦ê°€ => ê¸°ì¡´ê°’ì˜ **ë°°ë¡œ ì¦ê°€

temp = 0 ì¼ ë•Œ, ë¡œê·¸ì˜¤ì¦ˆ(y) = 5 # yë³€í™”ëŸ‰ = 5-3 = 2 -> ì˜¤ì¦ˆ = e^(5) = 148.4131591025766
temp = 1 ì¼ ë•Œ, ë¡œê·¸ì˜¤ì¦ˆ(y) = 3                  # ->  ì˜¤ì¦ˆ = e^(5-2) = e^5 * e^(-2) = 20.085536923187668  # e^(-2) = e^(5-2) / e^(5) = 0.1353352832366127ë°°ë¡œ ê°ì†Œ => ê¸°ì¡´ê°’ì˜ **ë°°ë¡œ ê°ì†Œ




# ë¬¸ì œ 7 : CELL ë³€ìˆ˜ì˜ 99% ì˜¤ì¦ˆë¹„ì— ëŒ€í•œ ì‹ ë¢°êµ¬ê°„ì„ êµ¬í•˜ì‹œì˜¤.
# CELL ë³€ìˆ˜ì˜ ë² íƒ€ì— ëŒ€í•œ 99 : (ë² íƒ€_hat - z(0.005)*SE , ë² íƒ€_hat + z(0.005)*SE)
z0005 = norm.ppf(0.995, loc=0, scale=1)
30.8301 - 52.135*z0005 , 30.8301 + 52.135*z0005
np.exp(30.8301 - 52.135*z0005) , np.exp(30.8301 + 52.135*z0005)  # (1.1683218982002717e-45, 5.141881884993857e+71)


# ë¬¸ì œ 8 : ì£¼ì–´ì§„ ë°ì´í„°ì— ëŒ€í•˜ì—¬ ë¡œì§€ìŠ¤í‹± íšŒê·€ ëª¨ë¸ì˜ ì˜ˆì¸¡ í™•ë¥ ì„ êµ¬í•œ í›„, 50% ì´ìƒì¸ ê²½ìš° 1ë¡œ ì²˜ë¦¬í•˜ì—¬, í˜¼ë™ í–‰ë ¬ë¥¼ êµ¬í•˜ì‹œì˜¤.
from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay


y_pred = model.predict(train)
result = pd.DataFrame({'y_pred' : y_pred})
result['result'] = np.where(result['y_pred']>=0.5, 1,0)

conf_mat = confusion_matrix(y_true = df['REMISS'], y_pred = result['result'], labels=[1,0])
p = ConfusionMatrixDisplay(confusion_matrix = conf_mat, display_labels = ('ê´€ì¸¡ë¶ˆê°€_1', 'ê´€ì¸¡ê°€ëŠ¥_0'))
plt.rcParams['font.family'] = 'Malgun Gothic'
p.plot(cmap="Blues")



# ë¬¸ì œ 9 : í•´ë‹¹ ëª¨ë¸ì˜ AccuracyëŠ” ì–¼ë§ˆì¸ê°€ìš”?
(5+15)/(5+3+4+15)  # 0.7407407407407407

from sklearn.metrics import accuracy_score, f1_score
accuracy_score(df['REMISS'], result['result'])  # 0.7407407407407407



# ë¬¸ì œ10 : í•´ë‹¹ ëª¨ë¸ì˜ F1 Scoreë¥¼ êµ¬í•˜ì„¸ìš”.
precision = 5/(5+3)
recall = 5/(5+4)

 2 / (1/precision + 1/recall)   # 0.5882352941176471


f1_score(df['REMISS'], result['result'])  # 0.5882352941176471




# ì •ë¦¬ ------------------------------------
import pandas as pd
import numpy as np
import statsmodels.api as sm


# ë¬¸ì œ1 : ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³ , ë¡œì§€ìŠ¤í‹± íšŒê·€ëª¨ë¸ì„ ì í•©í•˜ê³ , íšŒê·€ í‘œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
df = pd.read_csv('./leukemia_remission/leukemia_remission.txt', delim_whitespace= True) # delim_whitespace : ê³µë°± ì§€ìš°ê¸°
df.head()
train = df.drop(columns=('REMISS'))

model = sm.formula.logit("REMISS ~ CELL + SMEAR + INFIL + LI + BLAST + TEMP", data=df).fit()
print(model.summary())



# ë¬¸ì œ2 : í•´ë‹¹ ëª¨ë¸ì€ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œê°€ìš”? ê·¸ ì´ìœ ë¥¼ ê²€ì •í†µê³„ëŸ‰ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•˜ì‹œì˜¤
# ê²€ì •í†µê³„ëŸ‰ : âˆ’2(â„“(ğ›½)Ì‚ (0) âˆ’ â„“(ğ›½)Ì‚ )  =  -2*(-17.186+10.797)  = 12.779
1 - chi2.cdf(12.779, df=6)  # 0.0467

# ê²°ë¡  : LLR p-value: 0.0467 < ìœ ì˜ìˆ˜ì¤€ 0.05ë³´ë‹¤ ì‘ìœ¼ë‹ˆê¹Œ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.




# ë¬¸ì œ3 : ìœ ì˜ìˆ˜ì¤€ì´ 0.2ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œ ë³€ìˆ˜ëŠ” ëª‡ê°œì´ë©°, ì–´ëŠ ë³€ìˆ˜ ì¸ê°€ìš”?
# P>|z|ê°€ 0.2ë³´ë‹¤ ì‘ì€ LI, TEMPê°€ ìœ ì˜í•˜ë‹¤



# ë¬¸ì œ4 : ë‹¤ìŒ í™˜ìì— ëŒ€í•œ ì˜¤ì¦ˆëŠ” ì–¼ë§ˆì¸ê°€ìš”?
# CELL (ê³¨ìˆ˜ì˜ ì„¸í¬ì„±): 65%
# SMEAR (ê³¨ìˆ˜í¸ì˜ ë°±í˜ˆêµ¬ ë¹„ìœ¨): 45%
# INFIL (ê³¨ìˆ˜ì˜ ë°±í˜ˆë³‘ ì„¸í¬ ì¹¨íˆ¬ ë¹„ìœ¨): 55%
# LI (ê³¨ìˆ˜ ë°±í˜ˆë³‘ ì„¸í¬ì˜ ë¼ë²¨ë§ ì¸ë±ìŠ¤): 1.2
# BLAST (ë§ì´ˆí˜ˆì•¡ì˜ ë°±í˜ˆë³‘ ì„¸í¬ ìˆ˜): 1.1ì„¸í¬/Î¼L
# TEMP (ì¹˜ë£Œ ì‹œì‘ ì „ ìµœê³  ì²´ì˜¨): 0.9

odds = np.exp( 64.2581 + 30.8301*0.65 + 24.6863 * 0.45  - 24.9745 * 0.55 + 4.3605 * 1.2 - 0.0115*1.1 - 100.1734 * 0.9)  
# ì˜¤ì¦ˆ : 0.03817459641135519


# ë¬¸ì œ5 : ìœ„ í™˜ìì˜ í˜ˆì•¡ì—ì„œ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë˜ì§€ ì•Šì€ í™•ë¥ ì€ ì–¼ë§ˆì¸ê°€ìš”?
odds / (1+odds)  # 0.03677088280074742



# ë¬¸ì œ 6 : TEMP ë³€ìˆ˜ì˜ ê³„ìˆ˜ëŠ” ì–¼ë§ˆì´ë©°, í•´ë‹¹ ê³„ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ TEMP ë³€ìˆ˜ê°€ ë°±í˜ˆë³‘ ì¹˜ë£Œì— ëŒ€í•œ ì˜í–¥ì„ ì„¤ëª…í•˜ì‹œì˜¤.
# TEMP ë³€ìˆ˜ì˜ ê³„ìˆ˜ : -100.1734
# e^(-100.1734) = 3.13e-44 ëŠ” 0ì— ê°€ê¹Œìš´ ê°’ì…ë‹ˆë‹¤. ì´ëŠ” ì²´ì˜¨ì´ 1ë‹¨ìœ„ ìƒìŠ¹í•  ë•Œ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë˜ì§€ ì•Šì„ í™•ë¥ ì´ (ì˜¤ì¦ˆë¹„ë§Œí¼ ë³€ë™)ê±°ì˜ ì—†ì–´ì§€ëŠ” ê²ƒì„ ì˜ë¯¸ ->  ì˜¨ë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë  í™•ë¥  ë†’ì•„ì§.
# np.exp(-100.1734)ì€ 0ì— ê°€ê¹Œìš´ ê°’ì´ë‹¤. ì´ëŠ” ì²´ì˜¨ì´ 1ë‹¨ìœ„ ìƒìŠ¹í•  ë•Œ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë˜ì§€ ì•Šì„ í™•ë¥ ì´ ê±°ì˜ ì—†ì–´ì§€ëŠ” ê²ƒì„ ì˜ë¯¸(ì˜¤ì¦ˆë¹„ë§Œí¼ ë³€ë™)í•œë‹¤. ë”°ë¼ì„œ, ì˜¨ë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ë°±í˜ˆë³‘ ì„¸í¬ê°€ ê´€ì¸¡ë  í™•ë¥  ë†’ì•„ì§„ë‹¤.


# ë¬¸ì œ 7 : CELL ë³€ìˆ˜ì˜ 99% ì˜¤ì¦ˆë¹„ì— ëŒ€í•œ ì‹ ë¢°êµ¬ê°„ì„ êµ¬í•˜ì‹œì˜¤.
# CELL ë³€ìˆ˜ì˜ ë² íƒ€ì— ëŒ€í•œ 99% ì‹ ë¢°êµ¬ê°„ : (ë² íƒ€_hat - z(0.005)*SE , ë² íƒ€_hat + z(0.005)*SE)
# CELL ë³€ìˆ˜ì˜ ì˜¤ì¦ˆë¹„ì— ëŒ€í•œ 99% ì‹ ë¢°êµ¬ê°„ : (exp(ë² íƒ€_hat - z(0.005)*SE) , exp(ë² íƒ€_hat + z(0.005)*SE))

z0005 = norm.ppf(0.995, loc=0, scale=1)  # 2.5758293035489004

# CELL ë³€ìˆ˜ì˜ ë² íƒ€ì— ëŒ€í•œ 99% ì‹ ë¢°êµ¬ê°„ : (-103.4607607405219, 165.12096074052192
30.8301 - 52.135*z0005 , 30.8301 + 52.135*z0005 

# CELL ë³€ìˆ˜ì˜ ì˜¤ì¦ˆë¹„ì— ëŒ€í•œ 99% ì‹ ë¢°êµ¬ê°„ : (1.1683218982002717e-45, 5.141881884993857e+71)
np.exp(30.8301 - 52.135*z0005) , np.exp(30.8301 + 52.135*z0005)  



# ë¬¸ì œ 8 : ì£¼ì–´ì§„ ë°ì´í„°ì— ëŒ€í•˜ì—¬ ë¡œì§€ìŠ¤í‹± íšŒê·€ ëª¨ë¸ì˜ ì˜ˆì¸¡ í™•ë¥ ì„ êµ¬í•œ í›„, 50% ì´ìƒì¸ ê²½ìš° 1ë¡œ ì²˜ë¦¬í•˜ì—¬, í˜¼ë™ í–‰ë ¬ë¥¼ êµ¬í•˜ì‹œì˜¤.
from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay

y_pred = model.predict(train)
result = pd.DataFrame({'y_pred' : y_pred})
result['result'] = np.where(result['y_pred']>=0.5, 1,0)

conf_mat = confusion_matrix(y_true = df['REMISS'], y_pred = result['result'], labels=[1,0])
p = ConfusionMatrixDisplay(confusion_matrix = conf_mat, display_labels = ('ê´€ì¸¡ë¶ˆê°€_1', 'ê´€ì¸¡ê°€ëŠ¥_0'))
plt.rcParams['font.family'] = 'Malgun Gothic'
p.plot(cmap="Blues")



# ë¬¸ì œ 9 : í•´ë‹¹ ëª¨ë¸ì˜ AccuracyëŠ” ì–¼ë§ˆì¸ê°€ìš”?
(5+15)/(5+3+4+15)  # 0.7407407407407407

from sklearn.metrics import accuracy_score, f1_score
accuracy_score(df['REMISS'], result['result'])  # 0.7407407407407407



# ë¬¸ì œ10 : í•´ë‹¹ ëª¨ë¸ì˜ F1 Scoreë¥¼ êµ¬í•˜ì„¸ìš”.
precision = 5/(5+3)
recall = 5/(5+4)
 2 / (1/precision + 1/recall)   # 0.5882352941176471

f1_score(df['REMISS'], result['result'])  # 0.5882352941176471
